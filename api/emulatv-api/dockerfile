# ---------- stage 1: builder ----------
FROM eclipse-temurin:17-jdk AS builder
WORKDIR /workspace

# Copy build files to benefit from cache (dependencies)
COPY pom.xml mvnw ./
COPY .mvn .mvn

# Install dependencies (mvn dependency:go-offline) 
RUN ./mvnw -B dependency:go-offline

# Copy source code
COPY src ./src

# Build the application (will create target/*.jar)
RUN ./mvnw -B package -DskipTests

# ---------- stage 2: runtime ----------
FROM eclipse-temurin:17-jre-jammy
WORKDIR /app

# Create a non-root user (for security)
RUN useradd -m appuser
USER appuser

# Copy the jar file from the builder
COPY --from=builder /workspace/target/*.jar app.jar

EXPOSE 8080

# Env variables
ENV JAVA_TOOL_OPTIONS="-Xms256m -Xmx512m -Djava.security.egd=file:/dev/./urandom"

ENTRYPOINT ["java","-jar","/app/app.jar"]
